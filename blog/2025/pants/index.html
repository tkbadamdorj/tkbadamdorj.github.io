<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Cutting our CI test load by 60% on top of pants' built-in optimizations | Taivanbat Badamdorj (TK) </title> <meta name="author" content="Taivanbat Badamdorj"> <meta name="description" content=""> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://tkbadamdorj.github.io/blog/2025/pants/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Taivanbat Badamdorj (TK) </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Cutting our CI test load by 60% on top of pants' built-in optimizations</h1> <p class="post-meta"> Created in February 02, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/software-engineering"> <i class="fa-solid fa-hashtag fa-sm"></i> software-engineering</a>   <a href="/blog/tag/pants"> <i class="fa-solid fa-hashtag fa-sm"></i> pants</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="tldr">TL;DR:</h1> <ul> <li>As codebases grow, so do the number of tests and the duration of your CI pipeline</li> <li>However, not every test needs to run for every small change</li> <li> <a href="https://www.pantsbuild.org/" rel="external nofollow noopener" target="_blank">pants</a> is a build system that thrives at automatic dependency inference</li> <li>Because it infers dependencies, you can use it to only run the set of affected unit tests</li> <li>On top of pants’ built-in optimizations, I cut our CI test load by another 60% using pants’ dependency introspection tools</li> </ul> <h4 id="how-do-tests-get-in-the-way-of-moving-fast">How do tests get in the way of moving fast?</h4> <p>You decide as a team that tests are important. You don’t want broken code. So you make it a habit to add unit tests whenever you add new code. Small pull requests are also important, as they get faster and better reviews, improve code quality, and are less likely to break things (take a look at this <a href="https://www.swarmia.com/blog/why-small-pull-requests-are-better/" rel="external nofollow noopener" target="_blank">article</a>). Over time you develop a codebase that is robust and beautiful. But merging also takes longer because the suite of tests that need to be run before you can merge your code is much bigger! This can be frustrating as in many cases, you <em>know</em> what you wrote doesn’t affect anything else in the codebase.</p> <p>“Come on, I just added a simple print statement. Why do I need to wait 30 minutes to merge this code?” - you, probably.</p> <p>Well, pants is here to save you.</p> <h4 id="lets-put-some-pants-on-your-ci-pipeline">Let’s put some pants on your CI pipeline</h4> <p>Beyond what you are hopefully wearing right now at work, pants also refers to a build system. As the <a href="https://www.pantsbuild.org/stable/docs/introduction/welcome-to-pants" rel="external nofollow noopener" target="_blank">docs mention</a>, it wraps many underlying tools - “compilers, code generators, dependency resolvers, test runners, linters, formatters, packagers, REPLs and more.” You can read more about it, but the main thing we’re going to focus on is its dependency inference capabilities and how that affects testing.</p> <p><strong>pants’ dependency inference lets us run only affected tests.</strong> On a very high level, pants knows which files are connected. It automatically scans through your imports and says “Hey, it looks like <code class="language-plaintext highlighter-rouge">test_foo.py</code> depends on <code class="language-plaintext highlighter-rouge">foo.py</code>”.</p> <p>Using information like this, pants can run only the tests that are affected by changes you make in a new branch. The command looks like the following:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pants <span class="nt">--changed-since</span><span class="o">=</span>origin/main <span class="nb">test</span>
</code></pre></div></div> <p>If you make changes to <code class="language-plaintext highlighter-rouge">foo.py</code> it might say: “Hey, I can see that in this new branch, the one file that changed compared to the <code class="language-plaintext highlighter-rouge">main</code> branch is <code class="language-plaintext highlighter-rouge">foo.py</code>. Since <code class="language-plaintext highlighter-rouge">test_foo.py</code> is the one test that depends on this, let’s just run that test.”</p> <p>Now, consider the scenario where <code class="language-plaintext highlighter-rouge">bar.py</code> also depends on <code class="language-plaintext highlighter-rouge">foo.py</code>. It also has its own unit test <code class="language-plaintext highlighter-rouge">test_bar.py</code> that only imports from <code class="language-plaintext highlighter-rouge">bar.py</code>. When you change <code class="language-plaintext highlighter-rouge">foo.py</code> you want to ensure that <code class="language-plaintext highlighter-rouge">bar.py</code> also still works as expected i.e. you want <code class="language-plaintext highlighter-rouge">test_bar.py</code> to also run! <code class="language-plaintext highlighter-rouge">test_bar.py</code> is a <em>transitive</em> dependent. You can run the following command:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pants <span class="nt">--changed-since</span><span class="o">=</span>origin/main <span class="nt">--changed-dependents</span><span class="o">=</span>transitive <span class="nb">test</span>
</code></pre></div></div> <p>Here, pants says “Hey, you changed <code class="language-plaintext highlighter-rouge">foo.py</code>, and I can see that <code class="language-plaintext highlighter-rouge">test_foo.py</code> as well as <code class="language-plaintext highlighter-rouge">test_bar.py</code> depend on <code class="language-plaintext highlighter-rouge">foo.py</code> directly and transitively, respectively. Let me run both unit tests.”</p> <p>The speed up that you can get from this depends on how many tests you have, and how long each one takes. As a toy example, let’s say you have 100 independent modules, each with their own test that takes 1 second to run. In a new feature branch, you only change one of the modules. In this case, testing without pants would take 100 seconds, while testing with pants would take only 1 second.</p> <h4 id="reducing-our-ci-test-load-by-another-60">Reducing our CI test load by another 60%</h4> <p>In our case, we noticed a huge improvement to our testing times after the introduction of pants. Over time, however, I noticed that small changes in certain parts of the codebase were still triggering a whole swarm of tests.</p> <p>The approach outlined in the previous section is only as affective as your software design: for example, if all unit tests depend on a module <code class="language-plaintext highlighter-rouge">Foo</code>, and <code class="language-plaintext highlighter-rouge">Foo</code> depends on all other parts of the codebase, you’re back at square one: any change triggers all unit tests, so you don’t get as much of a speed up as you would ideally have.</p> <p>Thankfully, pants’ <code class="language-plaintext highlighter-rouge">dependents</code> (<a href="https://www.pantsbuild.org/dev/docs/using-pants/project-introspection#dependents---find-which-targets-depend-on-a-target" rel="external nofollow noopener" target="_blank">documentation</a>) and <code class="language-plaintext highlighter-rouge">paths</code> (<a href="https://www.pantsbuild.org/dev/docs/using-pants/project-introspection#paths---find-dependency-paths" rel="external nofollow noopener" target="_blank">documentation</a>) commands are perfect for this scenario.</p> <p>The <code class="language-plaintext highlighter-rouge">dependents</code> command shows you the list of files that depend on the file that you’re inspecting. Since our testing is done with the <code class="language-plaintext highlighter-rouge">--transitive</code> flag, we use the same flag for this command as well.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pants dependents <span class="nt">--transitive</span> &lt;file_name&gt;
</code></pre></div></div> <p>I picked a set of files that I knew were triggering unexpected tests, then filtered the outputs to only include test files.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pants dependents <span class="nt">--transitive</span> &lt;file_name&gt; | <span class="nb">grep </span>tests
</code></pre></div></div> <p>This gave me a set of tests that I could inspect. Given these tests, I used the <code class="language-plaintext highlighter-rouge">paths</code> command to figure out the dependency path:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pants paths <span class="nt">--from</span><span class="o">=</span>&lt;test_file&gt; <span class="nt">--to</span><span class="o">=</span>&lt;file_name&gt;
</code></pre></div></div> <p>In our case we got outputs like the following:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>
  <span class="o">[</span>
    &lt;test_file&gt;,
    ...,
    /.../conftest.py,
    ...,
    &lt;file_name&gt;,
  <span class="o">]</span>
<span class="o">]</span>
</code></pre></div></div> <p>Aha! A <code class="language-plaintext highlighter-rouge">conftest.py</code> was importing a whole range of dependencies, and since all tests in the suite depend on <code class="language-plaintext highlighter-rouge">conftest.py</code> although they don’t explicitly import from this file, <code class="language-plaintext highlighter-rouge">pants</code> was triggering a whole bunch of unrelated tests!</p> <p>To solve this, I refactored our test modules to break apart this dependency. I figured out what fixtures from the <code class="language-plaintext highlighter-rouge">conftest.py</code> were needed in which tests, and put them in their respective tests. Interestingly enough, it was very rare for a fixture in <code class="language-plaintext highlighter-rouge">confest.py</code> to actually be needed across multiple tests.</p> <p><strong>This fix reduced the average number of tests a given file triggers by 60%</strong>, a substantial improvement for us!</p> <h4 id="conclusion">Conclusion</h4> <p>I’ve thoroughly enjoyed using pants as it allows us to do what is only necessary. We also use it for linting, formatting, and type checking only the files that are affected by any changes since the main branch.</p> <p>I think the commands that I’ve found the most useful for me are <code class="language-plaintext highlighter-rouge">dependents</code> and <code class="language-plaintext highlighter-rouge">dependencies</code>, as they can help you to understand the structure of your code a lot better, and possibly fix things if the structure doesn’t meet your expectations e.g. “this module shouldn’t depend on this!”</p> <p>You can read more about some of the history of pants <a href="https://earthly.dev/blog/pants-build/" rel="external nofollow noopener" target="_blank">here</a>, and how to use it from the documentation <a href="https://www.pantsbuild.org/stable/docs/introduction/welcome-to-pants" rel="external nofollow noopener" target="_blank">here</a>.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ibis/">No more SQL: using ibis as a machine learning researcher</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Taivanbat Badamdorj. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?70d799092f862ad98c7876aa47712e20"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>